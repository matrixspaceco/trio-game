<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å›æ†¶ä¸‰é‡å¥ Trio Online</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #121212; --highlight: #f1c40f; --card-back: #2c3e50; }
        body { background: var(--bg); color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; user-select: none; }
        .status-bar { margin: 15px; font-size: 16px; color: var(--highlight); text-align: center; height: 3.5em; font-weight: bold; }
        .board { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin: 15px 0; width: 100%; max-width: 400px; }
        .card { aspect-ratio: 2/3; background: var(--card-back); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; border: 2px solid #444; transition: 0.2s; cursor: pointer; }
        .card.revealed { background: white; color: black; border-color: var(--highlight); transform: scale(1.05); }
        .hand-area { width: 100%; max-width: 400px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; margin-bottom: 10px; box-sizing: border-box; }
        .hand { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; min-height: 50px; }
        .card.hidden-hand { color: transparent; background: #222; }
        .score-board { display: flex; justify-content: space-around; width: 100%; max-width: 400px; font-weight: bold; padding: 10px 0; border-bottom: 1px solid #333; }
        .btn-action { background: var(--highlight); border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; margin: 10px; color: #000; cursor: pointer; }
        input { padding: 12px; border-radius: 8px; border: none; margin: 5px; width: 80%; text-align: center; background: #333; color: white; }
    </style>
</head>
<body>

<div id="login-ui">
    <h2 style="color:var(--highlight)">ğŸ§© Trio å›æ†¶ä¸‰é‡å¥</h2>
    <input type="text" id="roomId" placeholder="æˆ¿è™Ÿ (ä¾‹å¦‚: 888)">
    <input type="number" id="playerIdx" placeholder="ç©å®¶ç·¨è™Ÿ (0, 1, 2)">
    <br>
    <button class="btn-action" onclick="joinGame()">é€²å…¥éŠæˆ²</button>
</div>

<div id="game-ui" style="display:none;">
    <div class="score-board" id="score-el"></div>
    <div id="status" class="status-bar">è®€å–è³‡æ–™ä¸­...</div>
    <div id="others-area"></div>
    <div id="public-board" class="board"></div>
    <div class="hand-area"><div id="my-hand" class="hand"></div></div>
    <button id="host-btn" class="btn-action" style="display:none;" onclick="initDeck()">æˆ¿ä¸»æ´—ç‰Œç™¼ç‰Œ</button>
</div>

<audio id="snd-flip" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>
<audio id="snd-match" src="https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3"></audio>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCZC_ZG2F-Yx4gJqrEkVk12e_S2bEZEt4k",
        authDomain: "trio-online-game.firebaseapp.com",
        databaseURL: "https://trio-online-game-default-rtdb.firebaseio.com",
        projectId: "trio-online-game",
        storageBucket: "trio-online-game.firebasestorage.app",
        messagingSenderId: "498938859484",
        appId: "1:498938859484:web:07f43000a8b46a1f47c919"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let rId, myIdx, game;

    function playSound(id) {
        const s = document.getElementById(id);
        s.currentTime = 0;
        s.play().catch(()=>{}); // é¿å…ç€è¦½å™¨æ””æˆªè‡ªå‹•æ’­æ”¾
    }

    function joinGame() {
        rId = document.getElementById('roomId').value;
        myIdx = parseInt(document.getElementById('playerIdx').value);
        if (!rId || isNaN(myIdx)) return alert("è«‹å¡«å¯«æˆ¿è™Ÿèˆ‡ç·¨è™Ÿ");

        document.getElementById('login-ui').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        if (myIdx === 0) document.getElementById('host-btn').style.display = 'block';

        // é€™è£¡ç¢ºä¿é€£ç·šåˆ°æ­£ç¢ºçš„è·¯å¾‘
        db.ref('trio/' + rId).on('value', (s) => {
            game = s.val();
            if (game) {
                render();
            } else {
                document.getElementById('status').innerText = "æˆ¿é–“å»ºç«‹æˆåŠŸï¼è«‹æˆ¿ä¸»æ´—ç‰Œ";
            }
        });
    }

    function initDeck() {
        let cards = [];
        for(let i=1; i<=12; i++) cards.push(i, i, i);
        cards.sort(() => Math.random() - 0.5);

        let players = {};
        for(let i=0; i<3; i++) {
            let hand = cards.splice(0, 9).sort((a,b) => a-b);
            players[i] = { hand: hand, score: 0 };
        }

        db.ref('trio/' + rId).set({
            board: cards.map(v => ({v: v, open: false})),
            players: players,
            turn: 0,
            stack: [],
            count: 3
        });
    }

    function render() {
        // æ›´æ–°åˆ†æ•¸èˆ‡æ¸²æŸ“
        let sHtml = "";
        for(let i=0; i<game.count; i++) sHtml += `<div class="${game.turn === i ? 'active-turn' : ''}">P${i}: ${game.players[i].score}</div>`;
        document.getElementById('score-el').innerHTML = sHtml;

        // å…¬å…±ç‰Œ
        document.getElementById('public-board').innerHTML = game.board.map((c, i) => 
            `<div class="card ${c.open ? 'revealed' : ''}" onclick="pick('pub', null, ${i})">${c.open ? c.v : '?'}</div>`
        ).join('');

        // è‡ªå·±æ‰‹ç‰Œ
        let myHand = game.players[myIdx].hand || [];
        document.getElementById('my-hand').innerHTML = myHand.map((v, i) => 
            `<div class="card revealed" onclick="pick('my', ${myIdx}, ${i})">${v}</div>`
        ).join('');

        // å°æ‰‹æ‰‹ç‰Œ
        let oHtml = "";
        for(let i=0; i<game.count; i++) {
            if(i === myIdx) continue;
            oHtml += `<div class="hand-area"><div class="hand">`;
            (game.players[i].hand || []).forEach((v, idx) => {
                let isEdge = (idx === 0 || idx === (game.players[i].hand.length - 1));
                oHtml += `<div class="card ${isEdge ? '' : 'hidden-hand'}" onclick="pick('other', ${i}, ${idx})">${isEdge ? '?' : ''}</div>`;
            });
            oHtml += `</div></div>`;
        }
        document.getElementById('others-area').innerHTML = oHtml;

        const status = document.getElementById('status');
        if (game.turn === myIdx) status.innerHTML = "è¼ªåˆ°ä½ äº†ï¼è«‹ç¿»ç‰Œ";
        else status.innerHTML = `ç­‰å¾… P${game.turn} è¡Œå‹•...<br>å·²ç¿»: ${game.stack ? game.stack.join(', ') : 'ç„¡'}`;
    }

    async function pick(type, targetIdx, cardIdx) {
        if (game.turn !== myIdx) return;
        let stack = game.stack || [];
        if (stack.length >= 3) return;

        playSound('snd-flip'); // ç¿»ç‰ŒéŸ³æ•ˆ

        let val;
        let updates = {};
        if (type === 'pub') {
            if (game.board[cardIdx].open) return;
            val = game.board[cardIdx].v;
            updates[`/board/${cardIdx}/open`] = true;
        } else if (type === 'my') {
            val = game.players[myIdx].hand[cardIdx];
            updates[`/players/${myIdx}/hand/${cardIdx}`] = null;
        } else if (type === 'other') {
            let hand = game.players[targetIdx].hand;
            if (cardIdx !== 0 && cardIdx !== hand.length - 1) return;
            val = hand[cardIdx];
            updates[`/players/${targetIdx}/hand/${cardIdx}`] = null;
        }

        stack.push(val);
        updates['/stack'] = stack;
        await db.ref('trio/' + rId).update(updates);

        if (stack.length > 1 && stack[stack.length - 1] !== stack[0]) {
            setTimeout(resetTurn, 1200);
        } else if (stack.length === 3) {
            playSound('snd-match'); // é…å°æˆåŠŸéŸ³æ•ˆ
            setTimeout(winSet, 1000);
        }
    }

    function resetTurn() {
        let updates = { stack: [], turn: (game.turn + 1) % game.count };
        game.board.forEach((c, i) => { updates[`/board/${i}/open`] = false; });
        db.ref('trio/' + rId).update(updates);
    }

    function winSet() {
        let score = game.players[myIdx].score + 1;
        db.ref('trio/' + rId).update({ 
            stack: [], 
            [`/players/${myIdx}/score`]: score,
            turn: (game.turn + 1) % game.count 
        });
    }
</script>
</body>
</html>