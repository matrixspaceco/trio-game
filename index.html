<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å›æ†¶ä¸‰é‡å¥ Trio - æœ‹å‹é€£ç·šç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #121212; --highlight: #f1c40f; --card-back: #2c3e50; --btn: #f1c40f; }
        body { background: var(--bg); color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; user-select: none; }
        
        /* ç™»å…¥ä»‹é¢å„ªåŒ– */
        #login-box { background: #222; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-top: 50px; width: 85%; max-width: 350px; }
        input { width: 90%; padding: 15px; margin: 10px 0; border-radius: 10px; border: none; font-size: 16px; background: #333; color: white; text-align: center; }
        .btn-main { background: var(--btn); color: black; border: none; padding: 15px 30px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; font-size: 18px; margin-top: 10px; }
        
        /* éŠæˆ²ä»‹é¢ */
        .status-bar { margin: 15px; font-size: 18px; color: var(--highlight); text-align: center; font-weight: bold; line-height: 1.4; }
        .board { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin: 15px 0; width: 100%; max-width: 400px; }
        .card { aspect-ratio: 2/3; background: var(--card-back); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; border: 2px solid #444; transition: 0.2s; cursor: pointer; }
        .card.revealed { background: white; color: black; border-color: var(--highlight); transform: scale(1.05); }
        .hand-area { width: 100%; max-width: 400px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; margin-bottom: 10px; }
        .hand { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; min-height: 50px; }
        .card.hidden-hand { color: transparent; background: #222; }
        .active-turn { color: var(--highlight); text-decoration: underline; font-size: 1.1em; }
        .score-board { display: flex; justify-content: space-around; width: 100%; max-width: 400px; font-weight: bold; padding: 10px 0; border-bottom: 1px solid #333; }
    </style>
</head>
<body>

<div id="login-box">
    <h2 style="color:var(--highlight); margin-bottom:20px;">ğŸ§© Trio æˆ¿é–“é‚€è«‹</h2>
    <input type="text" id="userName" placeholder="è¼¸å…¥ä½ çš„åå­—">
    <input type="text" id="roomCode" placeholder="è¼¸å…¥æˆ¿é–“ä»£ç¢¼ (å¦‚: ABC)">
    <button class="btn-main" onclick="joinGame()">åŠ å…¥éŠæˆ²</button>
</div>

<div id="game-ui" style="display:none; width: 100%; max-width: 400px;">
    <div class="score-board" id="score-el"></div>
    <div id="status" class="status-bar">ç­‰å¾…é€£ç·š...</div>
    <div id="others-area"></div>
    <div id="public-board" class="board"></div>
    <div class="hand-area">
        <div style="font-size:12px; opacity:0.6; margin-bottom:5px;">æˆ‘çš„æ‰‹ç‰Œ</div>
        <div id="my-hand" class="hand"></div>
    </div>
    <button id="host-btn" class="btn-main" style="display:none;" onclick="initDeck()">æˆ¿ä¸»æ´—ç‰Œç™¼ç‰Œ</button>
</div>

<audio id="snd-flip" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>
<audio id="snd-match" src="https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3"></audio>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCZC_ZG2F-Yx4gJqrEkVk12e_S2bEZEt4k",
        authDomain: "trio-online-game.firebaseapp.com",
        databaseURL: "https://trio-online-game-default-rtdb.firebaseio.com",
        projectId: "trio-online-game",
        storageBucket: "trio-online-game.firebasestorage.app",
        messagingSenderId: "498938859484",
        appId: "1:498938859484:web:07f43000a8b46a1f47c919"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let myName, rCode, myIdx, game;

    async function joinGame() {
        myName = document.getElementById('userName').value.trim();
        rCode = document.getElementById('roomCode').value.trim().toUpperCase();
        
        if (!myName || !rCode) return alert("è«‹è¼¸å…¥åå­—èˆ‡æˆ¿é–“ä»£ç¢¼");

        // è‡ªå‹•åˆ†é…ç·¨è™Ÿï¼šæª¢æŸ¥æˆ¿é–“ç¾æœ‰äººæ•¸
        const snap = await db.ref('trio/' + rCode + '/playerList').get();
        let list = snap.val() || [];
        
        // å¦‚æœåå­—å·²åœ¨æ¸…å–®ä¸­ï¼Œç›´æ¥æ²¿ç”¨ç·¨è™Ÿï¼›å¦å‰‡æ–°å¢
        let existingIdx = list.indexOf(myName);
        if (existingIdx !== -1) {
            myIdx = existingIdx;
        } else {
            myIdx = list.length;
            list.push(myName);
            await db.ref('trio/' + rCode + '/playerList').set(list);
        }

        document.getElementById('login-box').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        if (myIdx === 0) document.getElementById('host-btn').style.display = 'block';

        db.ref('trio/' + rCode).on('value', (s) => {
            game = s.val();
            if (game && game.players) render();
            else document.getElementById('status').innerText = `ä½ å¥½ ${myName}ï¼\nç­‰å¾…æˆ¿ä¸»é–‹å±€...`;
        });
    }

    function initDeck() {
        let cards = [];
        for(let i=1; i<=12; i++) cards.push(i, i, i);
        cards.sort(() => Math.random() - 0.5);
        
        let pCount = game.playerList.length;
        let players = {};
        // æ ¹æ“šäººæ•¸ç™¼ç‰Œè¦å‰‡
        let handSize = (pCount === 3) ? 9 : (pCount === 4 ? 7 : 6);

        for(let i=0; i<pCount; i++) {
            let hand = cards.splice(0, handSize).sort((a,b) => a-b);
            players[i] = { hand: hand, score: 0, name: game.playerList[i] };
        }

        db.ref('trio/' + rCode).update({
            board: cards.map(v => ({v: v, open: false})),
            players: players,
            turn: 0,
            stack: [],
            count: pCount
        });
    }

    function render() {
        // åˆ†æ•¸èˆ‡åå­—
        let sHtml = "";
        for(let i=0; i<game.count; i++) {
            let p = game.players[i];
            sHtml += `<div class="${game.turn === i ? 'active-turn' : ''}">${p.name}: ${p.score}</div>`;
        }
        document.getElementById('score-el').innerHTML = sHtml;

        // å…¬å…±ç‰Œ
        document.getElementById('public-board').innerHTML = game.board.map((c, i) => 
            `<div class="card ${c.open ? 'revealed' : ''}" onclick="pick('pub', null, ${i})">${c.open ? c.v : '?'}</div>`
        ).join('');

        // è‡ªå·±æ‰‹ç‰Œ
        let myHand = game.players[myIdx] ? game.players[myIdx].hand : [];
        document.getElementById('my-hand').innerHTML = myHand.map((v, i) => 
            v === -1 ? `<div class="card" style="opacity:0"></div>` : `<div class="card revealed" onclick="pick('my', ${myIdx}, ${i})">${v}</div>`
        ).join('');

        // å°æ‰‹æ‰‹ç‰Œ (åªçœ‹é ­å°¾)
        let oHtml = "";
        for(let i=0; i<game.count; i++) {
            if(i === myIdx) continue;
            let h = game.players[i].hand || [];
            oHtml += `<div class="hand-area"><div style="font-size:10px; margin-bottom:5px;">${game.players[i].name} çš„æ‰‹ç‰Œ</div><div class="hand">`;
            h.forEach((v, idx) => {
                if (v === -1) { oHtml += `<div class="card" style="opacity:0"></div>`; return; }
                let first = h.findIndex(x => x !== -1);
                let last = h.length - 1 - [...h].reverse().findIndex(x => x !== -1);
                let edge = (idx === first || idx === last);
                oHtml += `<div class="card ${edge ? '' : 'hidden-hand'}" onclick="pick('other', ${i}, ${idx})">${edge ? '?' : ''}</div>`;
            });
            oHtml += `</div></div>`;
        }
        document.getElementById('others-area').innerHTML = oHtml;

        let activeName = game.players[game.turn].name;
        document.getElementById('status').innerHTML = (game.turn === myIdx) ? "æ›ä½ å‡ºç‰Œäº†ï¼" : `ç­‰å¾… ${activeName} è¡Œå‹•...`;
    }

    async function pick(type, tIdx, cIdx) {
        if (game.turn !== myIdx) return;
        document.getElementById('snd-flip').play().catch(()=>{});
        let stack = game.stack || [];
        if (stack.length >= 3) return;

        let v, up = {};
        if (type === 'pub') {
            if (game.board[cIdx].open) return;
            v = game.board[cIdx].v;
            up[`/board/${cIdx}/open`] = true;
            stack.push({v: v, type: 'pub', idx: cIdx});
        } else if (type === 'my') {
            v = game.players[myIdx].hand[cIdx];
            if (v === -1) return;
            up[`/players/${myIdx}/hand/${cIdx}`] = -1;
            stack.push({v: v, type: 'hand', owner: myIdx, idx: cIdx});
        } else if (type === 'other') {
            let h = game.players[tIdx].hand;
            let first = h.findIndex(x => x !== -1);
            let last = h.length - 1 - [...h].reverse().findIndex(x => x !== -1);
            if (cIdx !== first && cIdx !== last) return;
            v = h[cIdx];
            up[`/players/${tIdx}/hand/${cIdx}`] = -1;
            stack.push({v: v, type: 'hand', owner: tIdx, idx: cIdx});
        }
        up['/stack'] = stack;
        await db.ref('trio/' + rCode).update(up);

        if (stack.length > 1 && stack[stack.length-1].v !== stack[0].v) setTimeout(reset, 1500);
        else if (stack.length === 3) { document.getElementById('snd-match').play().catch(()=>{}); setTimeout(win, 1000); }
    }

    function reset() {
        let u = { stack: [], turn: (game.turn + 1) % game.count };
        game.board.forEach((c, i) => { u[`/board/${i}/open`] = false; });
        let currentP = JSON.parse(JSON.stringify(game.players));
        game.stack.forEach(item => {
            if (item.type === 'hand') {
                currentP[item.owner].hand[item.idx] = item.v;
                currentP[item.owner].hand = currentP[item.owner].hand.filter(x => x !== -1).sort((a,b) => a-b);
            }
        });
        u['/players'] = currentP;
        db.ref('trio/' + rCode).update(u);
    }

    function win() {
        let s = game.players[myIdx].score + 1;
        let u = { stack: [], [`/players/${myIdx}/score`]: s, turn: (game.turn + 1) % game.count };
        let currentP = JSON.parse(JSON.stringify(game.players));
        Object.keys(currentP).forEach(id => { currentP[id].hand = currentP[id].hand.filter(x => x !== -1).sort((a,b) => a-b); });
        u['/players'] = currentP;
        db.ref('trio/' + rCode).update(u);
        if (game.stack[0].v === 7 || s >= 3) { alert(s >= 3 ? "æ­å–œç²å‹ï¼" : "æ‹¿åˆ° 7 ä¸‰é‡å¥ï¼Œç›´æ¥ç²å‹ï¼"); initDeck(); }
    }
</script>
</body>
</html>