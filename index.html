<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Trio å›æ†¶ä¸‰é‡å¥ - è¦å‰‡å®Œå–„ç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #121212; --highlight: #f1c40f; --card-back: #2c3e50; }
        body { background: var(--bg); color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; user-select: none; }
        #login-box { background: #222; padding: 30px; border-radius: 20px; text-align: center; margin-top: 50px; width: 85%; max-width: 350px; border: 2px solid #444; }
        input { width: 90%; padding: 15px; margin: 10px 0; border-radius: 10px; border: none; background: #333; color: white; text-align: center; font-size: 16px; }
        .btn-main { background: var(--highlight); color: black; border: none; padding: 15px 30px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; font-size: 18px; }
        
        .status-bar { margin: 15px; font-size: 18px; color: var(--highlight); text-align: center; font-weight: bold; min-height: 4em; }
        .score-board { display: flex; justify-content: space-around; width: 100%; max-width: 400px; font-weight: bold; padding: 10px 0; border-bottom: 1px solid #333; margin-bottom: 10px; }
        
        /* ç‰Œæ¡Œä½ˆå±€ */
        .board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; width: 100%; max-width: 400px; }
        .card { aspect-ratio: 2/3; background: var(--card-back); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; border: 2px solid #444; transition: 0.2s; position: relative; }
        .card.revealed { background: #fff !important; color: #000 !important; border-color: var(--highlight); box-shadow: 0 0 15px var(--highlight); }
        
        /* æ‰‹ç‰Œå€åŸŸ */
        .hand-area { width: 100%; max-width: 400px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 15px; box-sizing: border-box; }
        .hand { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; min-height: 80px; }
        /* å¢åŠ æ‰‹ç‰Œçš„å¯é»æ“Šæ€§ */
        .card-hand { width: 50px; height: 75px; background: #fff; color: #000; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; font-size: 22px; border: 2px solid #ccc; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .card-hand:active { transform: scale(0.9); }
        
        /* å°æ‰‹æ‰‹ç‰Œå€ */
        .other-card-slot { width: 30px; height: 45px; background: #222; border: 1px dashed #444; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 14px; position: relative; }
        .other-card-slot.revealed { background: #fff; color: #000; border-style: solid; font-size: 18px; font-weight: bold; }
        
        .active-turn { color: var(--highlight); text-decoration: underline; }

        /* å½ˆçª— */
        #pick-panel { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #333; padding: 25px; border-radius: 20px; border: 3px solid var(--highlight); z-index: 1000; text-align: center; width: 280px; }
        .pick-btn { background: #444; color: white; border: 1px solid #666; padding: 12px; margin: 8px; border-radius: 10px; cursor: pointer; width: 90%; font-weight: bold; font-size: 16px; }
    </style>
</head>
<body id="main-body">

<div id="login-box">
    <h2 style="color:var(--highlight)">ğŸ§© Trio å›æ†¶ä¸‰é‡å¥</h2>
    <input type="text" id="userName" placeholder="ä½ çš„åå­—">
    <input type="text" id="roomCode" placeholder="é‚€è«‹ç¢¼ (å¦‚: VICKY)">
    <button class="btn-main" onclick="joinGame()">å³åˆ»é–‹å±€</button>
</div>

<div id="game-ui" style="display:none; width: 100%; max-width: 400px;">
    <div class="score-board" id="score-el"></div>
    <div id="status" class="status-bar">åŒæ­¥ä¸­...</div>
    <div id="others-area"></div>
    <div id="public-board" class="board"></div>
    <div class="hand-area">
        <div style="font-size:12px; opacity:0.6; margin-bottom:8px;">æˆ‘çš„æ‰‹ç‰Œ (åƒ…é™å…©ç«¯é»æ“Š)</div>
        <div id="my-hand" class="hand"></div>
    </div>
</div>

<div id="pick-panel">
    <p id="pick-msg" style="margin-bottom:15px; font-weight:bold;"></p>
    <button class="pick-btn" onclick="confirmPick('min')">æŸ¥çœ‹æœ€å°çš„ç‰Œ (å·¦ç«¯)</button>
    <button class="pick-btn" onclick="confirmPick('max')">æŸ¥çœ‹æœ€å¤§çš„ç‰Œ (å³ç«¯)</button>
</div>

<audio id="snd-flip" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>
<audio id="snd-match" src="https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3"></audio>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCZC_ZG2F-Yx4gJqrEkVk12e_S2bEZEt4k",
        authDomain: "trio-online-game.firebaseapp.com",
        databaseURL: "https://trio-online-game-default-rtdb.firebaseio.com",
        projectId: "trio-online-game",
        storageBucket: "trio-online-game.firebasestorage.app",
        messagingSenderId: "498938859484",
        appId: "1:498938859484:web:07f43000a8b46a1f47c919"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let myName, rCode, myIdx, game, targetP;

    async function joinGame() {
        myName = document.getElementById('userName').value.trim() || "ç©å®¶";
        rCode = document.getElementById('roomCode').value.trim().toUpperCase() || "GAME";
        
        const snap = await db.ref('trio/' + rCode + '/playerList').get();
        let list = snap.val() || [];
        myIdx = list.indexOf(myName);
        if (myIdx === -1) { 
            myIdx = list.length; list.push(myName); 
            await db.ref('trio/' + rCode + '/playerList').set(list); 
        }

        document.getElementById('login-box').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';

        db.ref('trio/' + rCode).on('value', (s) => {
            game = s.val();
            if (!game) return;
            if (myIdx === 0 && (!game.players)) {
                autoInit();
            } else if (game.players) {
                render();
                if (game.players[game.turn] && game.players[game.turn].isAI && myIdx === 0 && !game.lock) {
                    db.ref('trio/' + rCode).update({ lock: true });
                    setTimeout(aiTurn, 2500);
                }
            }
        });
    }

    function autoInit() {
        let pList = [myName, "ğŸ¤– é›»è…¦ A", "ğŸ¤– é›»è…¦ B"];
        let cards = [];
        for(let i=1; i<=12; i++) cards.push(i, i, i);
        cards.sort(() => Math.random() - 0.5);
        let players = {};
        for(let i=0; i<3; i++) {
            let hand = cards.splice(0, 9).sort((a,b) => a - b);
            players[i] = { hand: hand, score: 0, name: pList[i], isAI: pList[i].includes("ğŸ¤–") };
        }
        db.ref('trio/' + rCode).update({
            board: cards.map(v => ({v: v, open: false})),
            players: players, turn: 0, stack: [], count: 3, playerList: pList, lock: false, msg: ""
        });
    }

    function render() {
        if (!game || !game.players) return;
        const cp = game.players[game.turn] || { name: "..." };
        
        let sHtml = "";
        for(let i=0; i<game.count; i++) {
            const p = game.players[i] || { name: "P"+i, score: 0 };
            sHtml += `<div class="${game.turn === i ? 'active-turn' : ''}">${p.name}: ${p.score}</div>`;
        }
        document.getElementById('score-el').innerHTML = sHtml;

        document.getElementById('public-board').innerHTML = (game.board || []).map((c, i) => 
            `<div class="card ${c.open ? 'revealed' : ''}" onclick="pickAction('pub', null, ${i})">${c.open ? c.v : '?'}</div>`
        ).join('');

        // æ‰‹ç‰Œé»æ“Šé‚è¼¯ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºå…©ç«¯
        let myHand = (game.players[myIdx] && game.players[myIdx].hand) ? game.players[myIdx].hand : [];
        let firstIdx = myHand.findIndex(v => v !== -1);
        let lastIdx = myHand.length - 1 - [...myHand].reverse().findIndex(v => v !== -1);

        document.getElementById('my-hand').innerHTML = myHand.map((v, i) => {
            if (v === -1) return `<div style="width:50px;"></div>`;
            let isEdge = (i === firstIdx || i === lastIdx);
            return `<div class="card-hand" style="${isEdge ? '' : 'opacity:0.5; cursor:not-allowed;'}" onclick="${isEdge ? `pickAction('my', ${myIdx}, ${i})` : ''}">${v}</div>`;
        }).join('');

        let oHtml = "";
        for(let i=0; i<game.count; i++) {
            if(i === myIdx) continue;
            const p = game.players[i] || { name: "é›»è…¦", hand: [] };
            oHtml += `<div class="hand-area" onclick="openPickPanel(${i})">
                <div style="font-size:11px; margin-bottom:5px;">${p.name}</div>
                <div class="hand">`;
            
            (p.hand || []).forEach((v, idx) => {
                // æª¢æŸ¥é€™å¼µç‰Œæ˜¯å¦åœ¨ç›®å‰çš„ stack (å¾…ç¢ºèªå€) ä¸­
                let inStack = game.stack && game.stack.find(s => s.owner == i && s.idx == idx);
                if (v === -1 && !inStack) {
                    oHtml += `<div style="width:30px;"></div>`;
                } else if (inStack) {
                    oHtml += `<div class="other-card-slot revealed">${inStack.v}</div>`;
                } else {
                    oHtml += `<div class="other-card-slot">?</div>`;
                }
            });
            oHtml += `</div></div>`;
        }
        document.getElementById('others-area').innerHTML = oHtml;
        document.getElementById('status').innerHTML = (game.turn === myIdx) ? "è¼ªåˆ°ä½ äº†ï¼è«‹ç¿»ç‰Œ" : `ç­‰å¾… ${cp.name} è¡Œå‹•...<br><small>${game.msg || ''}</small>`;
    }

    function openPickPanel(idx) {
        if (game.turn !== myIdx || game.lock) return;
        targetP = idx;
        const p = game.players[idx] || { name: "å°æ‰‹" };
        document.getElementById('pick-msg').innerText = `æŸ¥çœ‹ ${p.name} çš„ç‰Œï¼š`;
        document.getElementById('pick-panel').style.display = 'block';
    }

    function confirmPick(mode) {
        document.getElementById('pick-panel').style.display = 'none';
        let h = game.players[targetP].hand;
        let cIdx = (mode === 'min') ? h.findIndex(x => x !== -1) : h.length - 1 - [...h].reverse().findIndex(x => x !== -1);
        db.ref('trio/' + rCode).update({ msg: `${myName} çœ‹äº† ${game.players[targetP].name} çš„ç‰Œ` });
        pickAction('other', targetP, cIdx);
    }

    async function pickAction(type, tIdx, cIdx) {
        if ((game.turn !== myIdx && !game.players[game.turn].isAI) || game.lock) return;
        let stack = game.stack || [];
        if (stack.length >= 3) return;
        
        let v, up = {};
        if (type === 'pub') {
            if (game.board[cIdx].open) return;
            v = game.board[cIdx].v; up[`/board/${cIdx}/open`] = true;
            stack.push({v: v, type: 'pub', idx: cIdx});
        } else {
            v = game.players[tIdx].hand[cIdx];
            if (v === -1 || v === undefined) return;
            up[`/players/${tIdx}/hand/${cIdx}`] = -1;
            stack.push({v: v, type: 'hand', owner: tIdx, idx: cIdx, v: v});
        }
        
        up['/stack'] = stack;
        document.getElementById('snd-flip').play().catch(()=>{});
        await db.ref('trio/' + rCode).update(up);

        if (stack.length > 1 && stack[stack.length-1].v !== stack[0].v) {
            db.ref('trio/' + rCode).update({ lock: true });
            setTimeout(resetTurn, 3000); 
        } else if (stack.length === 3) {
            document.getElementById('snd-match').play().catch(()=>{});
            setTimeout(winSet, 2000);
        }
    }

    function resetTurn() {
        let u = { stack: [], turn: (game.turn + 1) % game.count, msg: "ä¸ç¬¦ï¼Œå·²è“‹ç‰Œ", lock: false };
        game.board.forEach((c, i) => { u[`/board/${i}/open`] = false; });
        let currentP = JSON.parse(JSON.stringify(game.players));
        game.stack.forEach(item => {
            if (item.type === 'hand') {
                let h = currentP[item.owner].hand;
                h[item.idx] = item.v;
                currentP[item.owner].hand = h.filter(x => x !== -1).sort((a,b) => a - b);
            }
        });
        u['/players'] = currentP;
        db.ref('trio/' + rCode).update(u);
    }

    function winSet() {
        let s = game.players[game.turn].score + 1;
        let u = { stack: [], [`/players/${game.turn}/score`]: s, turn: game.turn, msg: "æˆåŠŸï¼ç¹¼çºŒè¡Œå‹•", lock: false };
        let currentP = JSON.parse(JSON.stringify(game.players));
        Object.keys(currentP).forEach(id => { currentP[id].hand = currentP[id].hand.filter(x => x !== -1).sort((a,b) => a - b); });
        u['/players'] = currentP;
        db.ref('trio/' + rCode).update(u);
        if (game.stack[0].v === 7 || s >= 3) {
            alert(game.players[game.turn].name + " ç²å‹ï¼");
            db.ref('trio/' + rCode).remove();
            location.reload();
        }
    }

    async function aiTurn() {
        if (!game || !game.players[game.turn]) return;
        let type = Math.random() > 0.6 ? 'pub' : 'other';
        let tIdx = (type === 'pub') ? game.turn : Math.floor(Math.random() * game.count);
        let h = game.players[tIdx].hand;
        let first = h.findIndex(x => x !== -1), last = h.length - 1 - [...h].reverse().findIndex(x => x !== -1);
        let cIdx = (type === 'pub') ? game.board.findIndex(c => !c.open) : (Math.random() > 0.5 ? first : last);
        pickAction(type, tIdx, cIdx);
    }
</script>
</body>
</html>